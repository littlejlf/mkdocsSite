<!DOCTYPE html>
<html class="no-js" lang="zh">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.5.3, mkdocs-material-9.5.3" name="generator"/>
<title>Concurrency - blog from lf</title>
<link href="../assets/stylesheets/main.50c56a3b.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../css/heti.css" rel="stylesheet"/>
<link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css" rel="stylesheet"/>
<script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<link href="../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
        html.glightbox-open { overflow: initial; height: 100%; }
        .gslide-title { margin-top: 0px; user-select: text; }
        .gslide-desc { color: #666; user-select: text; }
        .gslide-image img { background: white; }
        
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}
            </style> <script src="../assets/javascripts/glightbox.min.js"></script></head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#_1">
          跳转至
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="页眉" class="md-header__inner md-grid">
<a aria-label="blog from lf" class="md-header__button md-logo" data-md-component="logo" href=".." title="blog from lf">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4h-2M3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7H3m2-2v2h2V5H5m0 14h2v-2H5v2m0-6h2v-2H5v2Z"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            blog from lf
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Concurrency
            
          </span>
</div>
</div>
</div>
<script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/littlejlf/mkdocsSite" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="导航栏" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="blog from lf" class="md-nav__button md-logo" data-md-component="logo" href=".." title="blog from lf">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M17 4v6l-2-2-2 2V4H9v16h10V4h-2M3 7V5h2V4a2 2 0 0 1 2-2h12c1.05 0 2 .95 2 2v16c0 1.05-.95 2-2 2H7c-1.05 0-2-.95-2-2v-1H3v-2h2v-4H3v-2h2V7H3m2-2v2h2V5H5m0 14h2v-2H5v2m0-6h2v-2H5v2Z"></path></svg>
</a>
    blog from lf
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/littlejlf/mkdocsSite" title="前往仓库">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"></path></svg>
</div>
<div class="md-source__repository">
    GitHub
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_1" type="checkbox"/>
<label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
<span class="md-ellipsis">
    编译原理
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
            编译原理
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../Context-free%20grammar/">
<span class="md-ellipsis">
    Context free grammar
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_2" type="checkbox"/>
<label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
<span class="md-ellipsis">
    静态分析、程序检测
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_2_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
            静态分析、程序检测
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    None
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_3" type="checkbox"/>
<label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
<span class="md-ellipsis">
    并发
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_3_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
            并发
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    None
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_4" type="checkbox"/>
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    程序语言
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            程序语言
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    None
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_5" type="checkbox"/>
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    操作系统
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            操作系统
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    None
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle" id="__nav_6" type="checkbox"/>
<label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
<span class="md-ellipsis">
    随记内容
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_6_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_6">
<span class="md-nav__icon md-icon"></span>
            随记内容
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="..">
<span class="md-ellipsis">
    Welcome to MkDocs
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="目录" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      目录
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#_1">
<span class="md-ellipsis">
      关于原子操作和锁的碎碎念
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#volatile">
<span class="md-ellipsis">
      关于 volatile 的碎碎念
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#jmmjava">
<span class="md-ellipsis">
      JMM（java内存模型）
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#atomic">
<span class="md-ellipsis">
      Atomic
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h1>Concurrency</h1>
<p>线程安全要保证 原子性 可见性 有序性</p>
<pre><code>原子性保证指令在执行的过程中不会被打断，因为被打断的话会可能导致程序状态的改变，从而影响一致性
</code></pre>
<h4 id="_1">关于原子操作和锁的碎碎念</h4>
<p>原子操作是天然<em>互斥</em>的 而<strong>利用原子操作通过控制逻辑和状态实现的锁形成的<em>互斥区<em>（线程不休眠的自旋锁 待线程休眠的锁 ）可以使得互斥区内的语句都拥有</em>互斥<em>的特性</em>*；   互斥归互斥 但是线程之间的顺序还是不确定的 同步包含了某种特殊的语义，规定了线程的某种顺序 如读写锁<span class="heti-skip"><span class="heti-spacing"> </span>,<span class="heti-spacing"> </span></span>条件变量等 形成了某种特殊语义的互斥 就是说操纵互斥操作，去实现特殊语义 如 消费者<span class="heti-skip"><span class="heti-spacing"> </span>-<span class="heti-spacing"> </span></span>生产者这种语义 同步其实就是消除多线程，把多线程限制成单线程或者执行结果上等价于单线程 因为程序在某些情况下，是要求同步的，所以在并发的情况下要保证某些语段的顺序性 </em></strong>互斥是实现同步的一种工具，互斥加逻辑控制<span><span class="heti-spacing"> </span>***</span> </p>
<h4 id="volatile">关于<span class="heti-skip"><span class="heti-spacing"> </span>volatile<span class="heti-spacing"> </span></span>的碎碎念</h4>
<ul>
<li>
<p><span>volatile<span class="heti-spacing"> </span></span>解决可见性问题 缓存一致（<em>注意不是禁用缓存</em>）和指令重排<span class="heti-skip"><span class="heti-spacing"> </span>(<span class="heti-spacing"> </span></span>编译器优化重排<span class="heti-skip"><span class="heti-spacing"> </span>)<span class="heti-spacing"> </span></span>一写多读 且所以，<span>volatile<span class="heti-spacing"> </span></span>仅用在<span class="heti-skip"><span class="heti-spacing"> </span>set<span class="heti-spacing"> </span></span>或者<span class="heti-skip"><span class="heti-spacing"> </span>get<span class="heti-spacing"> </span></span>的场景，不适合用在<span class="heti-skip"><span class="heti-spacing"> </span>getAndOperate<span class="heti-spacing"> </span></span>场景以及<span class="heti-skip"><span class="heti-spacing"> </span>set<span class="heti-spacing"> </span></span>操作中修改变量前还有其他操作 <em>只有简单的赋值操作是原子的</em>  因为其不保证操作的原子性<span class="heti-skip"><span class="heti-spacing"> </span>https://www.zhihu.com/question/329746124/answer/2140946313 volatile<span class="heti-spacing"> </span></span>的好文</p>
<ul>
<li>
<p>关于为什么要禁止指令重排，单线程环境里面编译器的指令重排会确保程序最终执行结果和代码顺序执行的结果一致，即考虑指令之间的数据依赖性。<em>但是在多线程的情况下，编译器无法分析多线程下数据的依赖性，只会分析单个线程内的数据依赖性来进行指令的重排优化；这就破坏了程序原本的语义</em>。</p>
<p><span><span class="heti-spacing"> </span></span>考虑一个使用双重检查锁定（Double-Checked Locking）的单例模式示例，其中的指令重排可能导致问题在上述代码中，<span>getInstance<span class="heti-spacing"> </span></span>方法使用了双重检查锁定，意图在多线程环境下保证只创建一个单例对象。然而，这里存在指令重排的问题。<em>问题出现在实例化对象的那一行（instance = new Singleton();<heti-adjacent class="heti-adjacent-half">）</heti-adjacent>。由于指令重排，可能会先执行对象的分配和构造，然后再将引用赋值给<span><span class="heti-spacing"> </span>instance</span>，这可能导致其他线程在检查<span class="heti-skip"><span class="heti-spacing"> </span>1<span class="heti-spacing"> </span></span>处看到<span class="heti-skip"><span class="heti-spacing"> </span>instance<span class="heti-spacing"> </span></span>不为<span><span class="heti-spacing"> </span>null</span>，但实际上对象的构造可能还没有完成</em>为了解决这个问题，可以在<span class="heti-skip"><span class="heti-spacing"> </span>instance<span class="heti-spacing"> </span></span>变量上添加<span class="heti-skip"><span class="heti-spacing"> </span>volatile<span class="heti-spacing"> </span></span>关键字，以禁止指令重排</p>
<p>```java
public class Singleton {</p>
<p>private static Singleton instance;</p>
<p>private Singleton() {}</p>
<p>public static Singleton getInstance() {
    if (instance == null) {  // 检查1
        synchronized (Singleton.class) {
            if (instance == null) {  // 检查2
                instance = new Singleton();  // 问题所在
            }
        }
    }
    return instance;
}
}
```</p>
</li>
</ul>
<p>简单的说，修改<span class="heti-skip"><span class="heti-spacing"> </span>volatile<span class="heti-spacing"> </span></span>变量（而不是对简单变量的直接赋值，这是一个原子操作）分为四步：1）读取<span class="heti-skip"><span class="heti-spacing"> </span>volatile<span class="heti-spacing"> </span></span>变量到<span><span class="heti-spacing"> </span>local</span>；2）修改变量值；3）<span>local<span class="heti-spacing"> </span></span>值写回；4）插入内存屏障，即<span class="heti-skip"><span class="heti-spacing"> </span>lock<span class="heti-spacing"> </span></span>指令，让其他线程可见这样就很容易看出来，前三步都是不安全的，取值和写回之间，不能保证没有其他线程修改。原子性需要锁来保证。这也就是为什么，<span>volatile<span class="heti-spacing"> </span></span>只用来保证变量可见性，但不保证原子性。
***volatile实现的原理就是在加入一个内存屏障的指令
1)它确保指令重排序时不会把其后面的指令排到内存屏障之前的位置，也不会把前面的指令排到内存屏障的后面；即在执行到内存屏障这句指令时，在它前面的操作已经全部完成；即指令重排不能跨过内存屏障；
2）它会强制将对缓存的修改操作立即写入主存； 
3）如果是写操作，它会导致其他CPU中对应的缓存行无效 </p>
<hr/>
<p><span>lock<span class="heti-spacing"> </span></span>前缀指令<span class="heti-skip"><span class="heti-spacing"> </span>(<span class="heti-spacing"> </span></span>内存屏障<span class="heti-skip"><span class="heti-spacing"> </span>),<span class="heti-spacing"> </span></span>一个屏障会把这个屏障前写入的数据刷新到内存，这样任何试图读取该数据的线程将得到最新值，而不用考虑到底是被哪个<span class="heti-skip"><span class="heti-spacing"> </span>cpu<span class="heti-spacing"> </span></span>核心或者哪颗<span class="heti-skip"><span class="heti-spacing"> </span>CPU<span class="heti-spacing"> </span></span>执行的。如果你的字段是<span><span class="heti-spacing"> </span>volatile</span>，<span>Java<span class="heti-spacing"> </span></span>内存模型将在写操作后插入一个写屏障指令，在读操作前插入一个读屏障指令。</p>
</li>
</ul>
<h4 id="jmmjava">JMM（<span>java<span class="heti-spacing"> </span></span>内存模型）</h4>
<p>为什么提到<span><span class="heti-spacing"> </span>JMM</span>？<span>JMM<span class="heti-spacing"> </span></span>当中规定了可见性、原子性、以及有序性的问题，在多线程中只要保证了以上问题的正确性，那么基本上不会发生多线程当中存在数据安全问题</p>
<p>JMM（Java Memory Model）本身是一种抽象的概念，并不真实存在，他描述的时一组规则或规范，通过这组规范定义了程序中各个变量（包括实例字段，静态字段和构成数组对象的元素）的访问方式。</p>
<p><span>JMM<span class="heti-spacing"> </span></span>关于同步的规定：
线程解锁前，必须把共享变量的值刷新回主内存（即线程之间公共的内存 包括共用的缓存和主存） 刷出最新
线程加锁前，必须读取主内存的最新值到自己的工作内存（线程本地内存） 进来最新 
加锁解锁时同一把锁</p>
<p>如果同一个变量<span><span class="heti-spacing"> </span>i=0</span>，有两个线程执行<span class="heti-skip"><span class="heti-spacing"> </span>i++<span class="heti-spacing"> </span></span>方法，线程<span class="heti-skip"><span class="heti-spacing"> </span>1<span class="heti-spacing"> </span></span>把<span class="heti-skip"><span class="heti-spacing"> </span>i<span class="heti-spacing"> </span></span>从内存中读取进缓存，而现在线程<span class="heti-skip"><span class="heti-spacing"> </span>2<span class="heti-spacing"> </span></span>也把<span class="heti-skip"><span class="heti-spacing"> </span>i<span class="heti-spacing"> </span></span>读取进缓存，两个线程执行完<span class="heti-skip"><span class="heti-spacing"> </span>i++<span class="heti-spacing"> </span></span>后，线程<span class="heti-skip"><span class="heti-spacing"> </span>1<span class="heti-spacing"> </span></span>写回内存，i = 1，线程<span class="heti-skip"><span class="heti-spacing"> </span>2<span class="heti-spacing"> </span></span>也写回内存<span><span class="heti-spacing"> </span>i = 1</span>，两次<span class="heti-skip"><span class="heti-spacing"> </span>++<span class="heti-spacing"> </span></span>结果最终值为<span><span class="heti-spacing"> </span>1</span>，这就是著名的<strong>缓存一致性问题。为了解决这个问题，前人给了两种方案</strong></p>
<ul>
<li>总线锁  大锁
原子操作就是代表</li>
<li>缓存一致性协议
volatile就是代表
cpu为了和各个硬件打交道方便，设计师们把每个硬件都连接一个线到cpu，但是发现这样太麻烦了，所以改为所有硬件都挂在总线上，cpu通过总线和各个硬件打交道。</li>
</ul>
<p>如果使用总线锁，就阻塞了其他<span class="heti-skip"><span class="heti-spacing"> </span>cpu<span class="heti-spacing"> </span></span>和其他硬件交互<span class="heti-skip"><span class="heti-spacing"> </span>(<span class="heti-spacing"> </span></span>内存之类，磁盘，等等<span class="heti-skip"><span class="heti-spacing"> </span>),i++<span class="heti-spacing"> </span></span>这条语句就必须执行完了，其他<span class="heti-skip"><span class="heti-spacing"> </span>cpu<span class="heti-spacing"> </span></span>才能执行，否则只能一个<span class="heti-skip"><span class="heti-spacing"> </span>cpu<span class="heti-spacing"> </span></span>去和硬件交互。这也是一种解决办法，问题也明显，特别效率低下。</p>
<p>为了解决这个问题提出缓存一致性协议，具体协议就不讲，简单解释一下，如果我写入之后发现这是共享变量就使得其他<span class="heti-skip"><span class="heti-spacing"> </span>cpu<span class="heti-spacing"> </span></span>缓存了的值失效，让它再次去内存中读取</p>
<h4 id="atomic">Atomic</h4>
<p><span>Atomic<span class="heti-spacing"> </span></span>类中的操作通常包含内存屏障（memory barriers）在<span class="heti-skip"><span class="heti-spacing"> </span>Java<span class="heti-spacing"> </span></span>中，对基本数据类型的变量进行简单的赋值操作通常是原子的。这是因为基本数据类型的赋值操作对应的是一条简单的字节码指令请注意，对于<span class="heti-skip"><span class="heti-spacing"> </span>64<span class="heti-spacing"> </span></span>位的长整型（long）和双精度浮点型（double）等数据类型，由于它们的操作可能涉及多条机器指令，因此在某些平台上，对它们的赋值操作可能不是原子的。在多线程环境下，这可能导致一些线程在读取这些变量时看到了不完整或不一致的值。</p>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
<script src="../assets/javascripts/bundle.d7c377c4.min.js"></script>
<script src="../javascripts/katex.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
<script>document$.subscribe(() => {const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});})</script></body>
</html>